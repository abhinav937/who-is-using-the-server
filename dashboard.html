<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Server Sessions Dashboard</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 16px; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0; }
    .controls { display: flex; gap: 8px; align-items: center; }
    select, input, button { padding: 6px 10px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .card { border: 1px solid rgba(0,0,0,.1); border-radius: 10px; padding: 12px; background: rgba(255,255,255,.02); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid rgba(0,0,0,.08); font-size: 13px; }
    th { background: rgba(0,0,0,.04); position: sticky; top: 0; }
    .status { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .status.active { background: rgba(16,185,129,.15); color: #10b981; }
    .status.inactive { background: rgba(239,68,68,.15); color: #ef4444; }
    .muted { color: #666; font-size: 12px; }
    .summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .pill { padding: 4px 10px; background: rgba(0,0,0,.06); border-radius: 999px; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .right { text-align: right; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Server Sessions Dashboard</h1>
    <div class="controls">
      <label class="muted">Server:</label>
      <select id="serverFilter"></select>
      <label class="muted">Refresh:</label>
      <select id="refreshMs">
        <option value="0">Off</option>
        <option value="5000">5s</option>
        <option value="10000" selected>10s</option>
        <option value="30000">30s</option>
        <option value="60000">1m</option>
      </select>
      <button id="refreshBtn">Refresh Now</button>
    </div>
  </header>

  <div class="summary" id="summary"></div>

  <div class="grid">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Server</th>
            <th>User</th>
            <th class="right">CPU</th>
            <th class="right">Memory</th>
            <th>Last Heartbeat</th>
            <th>Status</th>
            <th class="right">Duration</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="card">
      <h3 style="margin-top:0">Raw Data</h3>
      <pre id="raw" style="white-space:pre-wrap; font-size:12px; margin:0"></pre>
    </div>
  </div>

  <script>
    // Construct API URL based on current location
    let apiUrl;
    if (location.pathname === '/' || location.pathname === '/dashboard' || location.pathname === '/dashboard.html') {
      apiUrl = '/api/index.js';
    } else {
      const apiBase = (location.pathname.endsWith('/')) ? location.pathname.slice(0, -1) : location.pathname;
      apiUrl = apiBase.replace(/\/index\.html$/, '/index.js');
    }

    const el = (id) => document.getElementById(id);
    let timer = null;

    function fmtBytes(v){ if(v==null) return ''; const mb = v/1024/1024; return mb.toFixed(1)+' MB'; }
    function fmtPct(v){ if(v==null) return ''; return Number(v).toFixed(0)+'%'; }
    function fmtTime(ms){ const d=new Date(ms); return d.toLocaleString(); }
    function fmtDur(sec){ if(!sec&&sec!==0) return ''; const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return (h? h+'h ':'')+ (m? m+'m ':'') + s+'s'; }

    async function fetchAll(serverId){
      const url = serverId ? `${apiUrl}?action=status&serverId=${encodeURIComponent(serverId)}` : `${apiUrl}`;
      console.log('Fetching from URL:', url);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if(!res.ok) {
        const text = await res.text();
        console.error('API response not OK:', res.status, text);
        throw new Error(`Failed to fetch: ${res.status} ${text}`);
      }
      return res.json();
    }

    function flatten(data){
      if(data.scope === 'server') {
        return data.activeSessions.map(s => ({ ...s, serverId: data.serverId }));
      }
      if(data.scope === 'all' && Array.isArray(data.servers)){
        return data.servers.flatMap(s => s.activeSessions.map(a => ({ ...a, serverId: s.serverId })));
      }
      // Back-compat fallback
      if(Array.isArray(data.activeSessions)) return data.activeSessions;
      return [];
    }

    function renderRows(sessions){
      const tbody = el('rows');
      tbody.innerHTML = '';
      sessions.sort((a,b)=> (a.serverId||'').localeCompare(b.serverId||'') || (a.username||'').localeCompare(b.username||''));
      for(const s of sessions){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${s.serverId||''}</td>
          <td class="nowrap">${s.username||''}</td>
          <td class="right">${fmtPct(s.cpu)}</td>
          <td class="right">${fmtBytes(s.memory)}</td>
          <td class="nowrap">${fmtTime(s.lastHeartbeat||0)}</td>
          <td><span class="status ${s.status==='active'?'active':'inactive'}">${s.status||''}</span></td>
          <td class="right">${fmtDur(s.sessionDuration)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderSummary(data){
      const box = el('summary');
      box.innerHTML = '';
      if(data.scope === 'server'){
        box.innerHTML = `
          <span class="pill">Scope: ${data.serverId}</span>
          <span class="pill">Active sessions: ${data.totalSessions}</span>
        `;
      } else if (data.scope === 'all'){
        const totalServers = data.totalServers ?? (data.servers? data.servers.length : 0);
        const totalSessions = data.totalSessions ?? 0;
        box.innerHTML = `
          <span class="pill">Scope: all servers</span>
          <span class="pill">Servers: ${totalServers}</span>
          <span class="pill">Active sessions: ${totalSessions}</span>
        `;
      }
    }

    function updateServerFilter(data){
      const sel = el('serverFilter');
      const prev = sel.value;
      
      // Get servers from current data
      let servers = [];
      if(data.scope==='all' && Array.isArray(data.servers)) {
        servers = data.servers.map(s=>s.serverId);
      } else if(data.serverId) {
        servers = [data.serverId];
      }
      
      // Also check if we have any sessions that might have server info
      if(data.scope==='all' && Array.isArray(data.servers)) {
        const sessionServers = data.servers.flatMap(s => s.activeSessions.map(session => session.serverId)).filter(Boolean);
        servers = [...new Set([...servers, ...sessionServers])];
      }
      
      const set = new Set(['', ...servers]);
      sel.innerHTML = '';
      for(const id of set){
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id? id : 'All servers';
        sel.appendChild(opt);
      }
      if(set.has(prev)) sel.value = prev;
    }

    async function refresh(){
      try {
        const serverId = el('serverFilter').value || undefined;
        console.log('Fetching data for serverId:', serverId);
        const data = await fetchAll(serverId);
        console.log('API response:', data);
        renderSummary(data);
        updateServerFilter(data);
        renderRows(flatten(data));
        el('raw').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        console.error('Refresh error:', error);
        el('raw').textContent = 'Error: ' + error.message;
      }
    }

    function setup(){
      el('refreshBtn').addEventListener('click', ()=> refresh().catch(console.error));
      el('refreshMs').addEventListener('change', (e)=>{
        const ms = parseInt(e.target.value, 10);
        if(timer){ clearInterval(timer); timer=null; }
        if(ms>0){ timer = setInterval(()=> refresh().catch(console.error), ms); }
      });
      el('serverFilter').addEventListener('change', ()=> refresh().catch(console.error));
      // default auto-refresh value
      const ms = parseInt(el('refreshMs').value, 10);
      if(ms>0){ timer = setInterval(()=> refresh().catch(console.error), ms); }
      refresh().catch(console.error);
    }

    setup();
  </script>
</body>
</html>
